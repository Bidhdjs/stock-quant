# 策略回测流程说明（EnhancedVolumeStrategy）

**命令入口**
```
python -m core.cli backtest --csv data/stock/akshare/US.AAPL_AAPL_20211126_20251124.csv --strategy EnhancedVolumeStrategy
```

## 1. 总体流程图（Mermaid）

```mermaid
flowchart TD
    A[CLI 命令] --> B[core/cli.py: cmd_backtest]
    B --> C[StrategyManager 获取策略类]
    B --> D[core/quant/quant_manage.py: run_backtest_enhanced_volume_strategy]
    D --> E[读取 CSV -> DataFrame]
    D --> F[构建 Backtrader DataFeed]
    D --> G[cerebro.addstrategy(EnhancedVolumeStrategy)]
    G --> H[cerebro.run()]
    H --> I[EnhancedVolumeStrategy.next]
    I --> J[EnhancedVolumeIndicator.next 产生信号]
    I --> K[trading_strategy_buy/sell]
    H --> L[notify_order / notify_trade]
    H --> M[统计回测结果]
    H --> N[信号记录导出 + Plotly HTML]
```

## 2. 关键伪代码（核心路径）

### 2.1 CLI 入口
```
cmd_backtest(args):
  csv_path = args.csv
  strategy_class = StrategyManager().get_strategy(args.strategy)
  run_backtest_enhanced_volume_strategy(csv_path, strategy_class)
```

### 2.2 回测执行
```
run_backtest_enhanced_volume_strategy(csv_path, strategy_class):
  df = read_csv(csv_path)
  data_feed = create_backtrader_feed(df)
  cerebro.adddata(data_feed)
  cerebro.addstrategy(strategy_class)
  results = cerebro.run()
  strategy = results[0]
  export_signal_records_if_any(strategy.indicator)
  plotly_draw(csv_path, strategy, init_cash, html_path)
```

### 2.3 策略逻辑（消费信号）
```
EnhancedVolumeStrategy.next():
  if order exists: return
  if indicator.enhanced_buy_signal:
      trading_strategy_buy()
      buy_signals_count += 1
  elif indicator.enhanced_sell_signal:
      trading_strategy_sell()
      sell_signals_count += 1
```

### 2.4 信号生成（Indicator）
```
EnhancedVolumeIndicator.next():
  计算成交量/均线偏离 + RSI + 布林带 + KDJ
  main_buy/main_sell = 基础信号
  enhanced_buy/enhanced_sell = 过滤后信号
  if enhanced_buy: lines.enhanced_buy_signal = price
  if enhanced_sell: lines.enhanced_sell_signal = price
  同步写入 SignalRecordManager
```

## 3. 关键代码节点（文件与职责）

- CLI 入口：`core/cli.py`
  - `cmd_backtest()` 负责解析参数并调用回测入口

- 回测执行：`core/quant/quant_manage.py`
  - `run_backtest_enhanced_volume_strategy()` 读取 CSV、运行回测、输出报告

- 策略实现：`core/strategy/trading/volume/enhanced_volume.py`
  - `EnhancedVolumeStrategy.next()` 读取信号并触发买卖

- 信号生成：`core/strategy/indicator/volume/enhanced_volume.py`
  - `EnhancedVolumeIndicator.next()` 生成增强信号

- 指标计算：`core/analysis/indicators/volume.py`
  - 统一计算量能/RSI/BOLL/KDJ等基础指标供信号层规则判断

- 信号记录：`core/strategy/indicator/common.py`
  - `SignalRecordManager.add_signal_record()`

- 交易记录与统计：`core/strategy/trading/common.py`
  - `StrategyBase.notify_order()` / `notify_trade()`

- 可视化输出：`core/visualization/visual_tools_plotly.py`
  - `plotly_draw()` 生成 HTML 报告

## 4. EnhancedVolumeStrategy 信号触发原理（补充说明）

### 4.1 信号层级
- 主信号：成交量放大 + 均线方向 + 连续阴/阳线形态
- 增强信号：主信号 + RSI + 布林带 + KDJ 多重过滤

### 4.2 主信号的原理
- 成交量放大：短期成交量均线显著高于中/长期均量（带波动修正阈值）
- 均线方向：在连续 3 天阴/阳线背景下，短均线相对当前价格形成方向性判断
- 组合逻辑：买/卖计数在 5 日与 20 日两个周期同时满足才触发主信号

### 4.3 增强信号的原理
- RSI：超卖/超买区间或穿越
- 布林带：触及下轨(买)或上轨(卖)并确认
- KDJ：K/D/J 同时处于极端区间
- 增强信号 = 主信号 + RSI + 布林带 + KDJ 同时满足

### 4.4 简单案例（买入信号示例）

**场景描述**：某股票在一段下跌后出现缩量企稳，短期均量开始抬升。连续 3 天阴线后，价格在布林带下轨附近止跌，RSI 低位回升，KDJ 同步进入低位区间。

**满足条件**（概念级示例）：
- 近 5 日成交量均线显著高于 20 日均线 → 量能放大
- 连续 3 天阴线，但短均线高于当前收盘价 → 主信号买入方向成立
- RSI < 30 或刚上穿 30 → 超卖回升
- 价格触及布林带下轨，并收盘回到下轨上方 → 反弹确认
- KDJ 低位（K/D/J < 20）→ 动能低位

**结果**：
- 主信号成立
- 增强信号成立 → EnhancedVolumeStrategy 执行买入

> 说明：这是逻辑示例，用于理解信号触发条件；实际触发取决于具体数据序列。

## 5. SingleVolumeStrategy 与 EnhancedVolumeStrategy 的差异（回测层面）

### 5.1 信号来源差异
- **SingleVolumeStrategy**：只使用主信号 `main_buy_signal` / `main_sell_signal`
- **EnhancedVolumeStrategy**：只使用增强信号 `enhanced_buy_signal` / `enhanced_sell_signal`
  - 主信号在策略层被注释，不参与交易

对应代码：
- Single：`core/strategy/trading/volume/single_volume_.py`
- Enhanced：`core/strategy/trading/volume/enhanced_volume.py`

### 5.2 信号触发强度差异
- Single 的主信号只要求成交量 + 均线方向 + 连续阴/阳线形态
- Enhanced 的增强信号在主信号基础上，再加 RSI / 布林带 / KDJ 多重过滤

**结果**：
- Single 交易次数更高、信号更密集
- Enhanced 交易次数更低、信号更保守

### 5.3 回测执行逻辑是否有区别
**没有差别**。两者的回测执行流程完全一致：
- 相同的资金/仓位管理
- 相同的下单逻辑与手续费计算
- 相同的 Backtrader 回测调用链

差异只来自 **信号触发条件**（Indicator 输出的信号线不同）。
