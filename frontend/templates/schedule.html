<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>定时任务管理 - 股票量化回测系统</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container-fluid p-0">
        <!-- 顶部导航栏 -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
            <div class="container-fluid px-0">
                <div class="content">
                    <div class="d-flex justify-content-between align-items-center w-100">
                        <a class="navbar-brand" href="/">股票量化回测系统</a>
                        <div class="d-flex align-items-center">
                            <div class="navbar-nav me-4">
                                <a class="nav-link" href="/#data-acquisition">数据获取</a>
                                <a class="nav-link active" href="/#backtest">回测</a>
                                <a class="nav-link" href="/#results">历史结果</a>
                                <a class="nav-link" href="/signal_analysis">信号分析</a>
                                <a class="nav-link" href="/strategy_code">策略管理</a>
                                <a class="nav-link" href="/schedule">定时任务</a>
                            </div>
                            <a href="https://github.com/zhaoxusun/stock-quant" target="_blank" class="btn btn-outline-light btn-sm github-link">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-github" viewBox="0 0 16 16">
                                    <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
                                </svg>
                                GitHub
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- 主要内容区域 -->
        <div class="content pt-4">
            <!-- 任务操作卡片 -->
            <div class="card mt-4" id="task-form">
                <div class="card-header bg-primary text-white">
                    <span id="form-title">创建定时任务</span>
                </div>
                <div class="card-body">
                    <form id="taskForm">
                        <input type="hidden" id="taskId" name="taskId">

                        <div class="row g-3">
                            <!-- 任务名称 -->
                            <div class="col-md-4">
                                <label for="taskName" class="form-label">任务名称 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="taskName" name="taskName" placeholder="请输入任务名称" required>
                                <div class="invalid-feedback">任务名称不能为空</div>
                            </div>

                            <!-- 任务类型 -->
                            <div class="col-md-4">
                                <label for="taskType" class="form-label">任务类型 <span class="text-danger">*</span></label>
                                <select class="form-select" id="taskType" name="taskType" required>
                                    <option value="">请选择任务类型</option>
                                    <option value="backtest">股票数据获取+回测+信号检查</option>
                                </select>
                                <div class="invalid-feedback">请选择任务类型</div>
                            </div>

                            <!-- 描述 -->
                            <div class="col-md-4">
                                <label for="description" class="form-label">描述 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="description" name="description" placeholder="请输入任务描述" required>
                                <div class="invalid-feedback">任务描述不能为空</div>
                            </div>

                            <!-- 定时表达式 - 修改宽度为col-md-4 -->
                            <div class="col-md-4">
                                <label for="scheduleTime" class="form-label">定时表达式 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="scheduleTime" name="scheduleTime" placeholder="例如: 0 8 * * 1-5 (工作日早上8点执行)" required>
                                <div class="invalid-feedback">定时表达式不能为空</div>
                                <small class="form-text text-muted mt-1">Cron格式: 分 时 日 月 周</small>
                            </div>

                            <!-- 数据源 -->
                            <div class="col-md-4" id="dataSourceField">
                                <label for="dataSource" class="form-label">数据源 <span class="text-danger">*</span></label>
                                <select class="form-select" id="dataSource" name="dataSource" required>
                                    <option value="">请选择数据源</option>
                                    <option value="akshare">akshare</option>
                                    <option value="baostock">baostock</option>
                                    <option value="futu">futu</option>
                                </select>
                                <div class="invalid-feedback">请选择数据源</div>
                            </div>

                            <!-- 市场 -->
                            <div class="col-md-4" id="marketField">
                                <label for="market" class="form-label">市场 <span class="text-danger">*</span></label>
                                <select class="form-select" id="market" name="market" required>
                                    <option value="">请选择市场</option>
                                    <option value="us">美股</option>
                                    <option value="cn">A股</option>
                                    <option value="hk">港股</option>
                                </select>
                                <div class="invalid-feedback">请选择市场</div>
                            </div>

                            <!-- 股票代码 -->
                            <div class="col-md-4" id="stockCodeField">
                                <label for="stockCode" class="form-label">股票代码 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="stockCode" name="stockCode" placeholder="例如: IVV, 600519, 00700" required>
                                <div class="invalid-feedback">股票代码不能为空</div>
                            </div>

                            <!-- 复权类型 -->
                            <div class="col-md-4" id="adjustTypeField">
                                <label for="adjustType" class="form-label">复权类型 <span class="text-danger">*</span></label>
                                <select class="form-select" id="adjustType" name="adjustType" required>
                                    <option value="qfq">前复权</option>
                                    <option value="hfq">后复权</option>
                                    <option value="None">不复权</option>
                                </select>
                                <div class="invalid-feedback">请选择复权类型</div>
                            </div>

                            <!-- 策略名称 -->
                            <div class="col-md-4" id="strategyField">
                                <label for="strategy" class="form-label">策略选择</label>
                                <select class="form-select" id="strategy" name="strategy" required>
                                    {% for strategy_name in strategies %}
                                    <option value="{{ strategy_name }}">{{ strategy_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- 初始资金 -->
                            <div class="col-md-4" id="initCashField">
                                <label for="initCash" class="form-label">初始资金 <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="initCash" name="initCash" value="5000000" required>
                                <div class="invalid-feedback">初始资金不能为空</div>
                            </div>

                            <!-- 回测周期 -->
                            <div class="col-md-4" id="duringField">
                                <label for="during" class="form-label">回测周期(天) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="during" name="during" value="1460" max="1460" required>
                                <div class="invalid-feedback">回测周期不能为空</div>
                            </div>

                            <!-- 表单按钮 -->
                            <div class="col-12 mt-3">
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary" id="submitButton">创建任务</button>
                                    <button type="button" class="btn btn-secondary" id="cancelButton">取消</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 任务列表卡片 -->
            <div class="card mt-4" id="task-list">
                <div class="card-header bg-primary text-white">
                    <span>定时任务列表</span>
                </div>
                <div class="card-body">
                    <!-- 加载状态 -->
                    <div id="loading" class="d-none text-center py-4">
                        <div class="loading"></div>
                        <p class="mt-2">加载中...</p>
                    </div>

                    <!-- 任务列表 -->
                    <div id="taskTableContainer">
                        <table class="table table-dark table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>任务名称</th>
                                    <th>任务类型</th>
                                    <th>定时表达式</th>
                                    <th>状态</th>
                                    <th>创建时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="taskTableBody">
                                <!-- 任务数据将通过JavaScript动态加载 -->
                            </tbody>
                        </table>
                    </div>

                    <!-- 无数据提示 -->
                    <div id="noTasks" class="d-none text-center py-8">
                        <p>暂无定时任务</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 通知组件 -->
    <div id="notification" class="notification position-fixed top-20 right-5 p-4 rounded shadow-lg z-50 transform transition-all duration-300 translate-x-full opacity-0">
        <div id="notificationMessage"></div>
    </div>
    <div id="confirmDialog" class="confirm-dialog hidden">
        <div class="confirm-dialog-content">
            <h3 id="confirmDialogTitle" class="confirm-dialog-title"></h3>
            <p id="confirmDialogMessage" class="confirm-dialog-message"></p>
            <div class="confirm-dialog-buttons">
                <button id="confirmDialogCancel" class="btn btn-secondary">取消</button>
                <button id="confirmDialogConfirm" class="btn btn-danger">确认</button>
            </div>
        </div>
    </div>

    <style>
        /* 确认对话框样式 */
        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1050;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .confirm-dialog.show {
            opacity: 1;
        }

        .confirm-dialog.hidden {
            display: none;
        }

        .confirm-dialog-content {
            background-color: white;
            border-radius: 8px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }

        .confirm-dialog.show .confirm-dialog-content {
            transform: translateY(0);
        }

        .confirm-dialog-title {
            margin-top: 0;
            margin-bottom: 16px;
            font-size: 1.25rem;
            color: #333;
        }

        .confirm-dialog-message {
            margin-bottom: 24px;
            color: #555;
            line-height: 1.5;
        }

        .confirm-dialog-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
    </style>

    <script>
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {

            // 加载任务列表
            loadTasks();

            // 任务类型选择变化时，动态显示/隐藏相关字段
            document.getElementById('taskType').addEventListener('change', function() {
                const taskType = this.value;
                const dataSourceField = document.getElementById('dataSourceField');
                const marketField = document.getElementById('marketField');
                const stockCodeField = document.getElementById('stockCodeField');
                const adjustTypeField = document.getElementById('adjustTypeField');
                const strategyField = document.getElementById('strategyField');
                const initCashField = document.getElementById('initCashField');
                const duringField = document.getElementById('duringField');

                // 重置必填状态
                document.getElementById('dataSource').required = true;
                document.getElementById('market').required = true;
                document.getElementById('stockCode').required = true;
                document.getElementById('adjustType').required = true;
                document.getElementById('strategy').required = true;
                document.getElementById('initCash').required = true;
                document.getElementById('during').required = true;

                // 根据任务类型显示不同的字段
                if (taskType === 'backtest') {
                    dataSourceField.classList.remove('d-none');
                    marketField.classList.remove('d-none');
                    stockCodeField.classList.remove('d-none');
                    adjustTypeField.classList.remove('d-none');
                    strategyField.classList.remove('d-none');
                    initCashField.classList.remove('d-none');
                    duringField.classList.remove('d-none');
                    document.getElementById('dataSource').required = true;
                    document.getElementById('market').required = true;
                    document.getElementById('stockCode').required = true;
                    document.getElementById('adjustType').required = true;
                    document.getElementById('strategy').required = true;
                    document.getElementById('initCash').required = true;
                    document.getElementById('during').required = true;
                }
            });

            // 表单提交处理
            document.getElementById('taskForm').addEventListener('submit', function(e) {
                e.preventDefault();

                // 表单验证
                if (!this.checkValidity()) {
                    e.stopPropagation();
                    this.classList.add('was-validated');
                    return;
                }

                const taskId = document.getElementById('taskId').value;
                const taskData = {
                    // 使用正确的字段名称
                    name: document.getElementById('taskName').value,
                    type: document.getElementById('taskType').value,
                    description: document.getElementById('description').value,
                    schedule_time: document.getElementById('scheduleTime').value,
                    enabled: true // 默认启用
                };

                // 添加target_stocks数组
                if (document.getElementById('dataSource').required &&
                    document.getElementById('market').required &&
                    document.getElementById('stockCode').required &&
                    document.getElementById('adjustType').required) {

                    taskData.target_stocks = [{
                        market: document.getElementById('market').value,
                        data_source: document.getElementById('dataSource').value,
                        stock_code: document.getElementById('stockCode').value,
                        adjust_type: document.getElementById('adjustType').value
                    }];
                }

                // 添加backtest_config对象
                if (document.getElementById('strategy').required) {
                    taskData.backtest_config = {
                        strategy: document.getElementById('strategy').value
                    };

                    // 添加回测配置的可选字段
                    if (document.getElementById('initCash').required) {
                        taskData.backtest_config.init_cash = parseInt(document.getElementById('initCash').value);
                    }
                    if (document.getElementById('during').required) {
                        taskData.backtest_config.during = parseInt(document.getElementById('during').value);
                    }
                }

                if (taskId) {
                    // 更新任务
                    updateTask(taskId, taskData);
                } else {
                    // 创建任务
                    createTask(taskData);
                }
            });

            // 取消按钮事件
            document.getElementById('cancelButton').addEventListener('click', resetForm);
            document.getElementById('cancelButton').addEventListener('click', loadTasks);

        });

        // 加载所有任务
        function loadTasks() {
            showLoading(true);

            fetch('/api/tasks/get_all')
                .then(response => response.json())
                .then(data => {
                    showLoading(false);

                    const taskTableBody = document.getElementById('taskTableBody');
                    const noTasksDiv = document.getElementById('noTasks');

                    taskTableBody.innerHTML = '';

                    if (data.success && data.data && data.data.length > 0) {
                        // 按create_time倒序排列任务
                        const sortedTasks = data.data.sort((a, b) => {
                            const dateA = new Date(a.create_time || 0).getTime();
                            const dateB = new Date(b.create_time || 0).getTime();
                            return dateB - dateA; // 倒序排列
                        });

                        // 显示任务列表
                        noTasksDiv.classList.add('d-none');
                        document.getElementById('taskTableContainer').classList.remove('d-none');

                        sortedTasks.forEach(task => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${task.id}</td>
                                <td>${task.name}</td>
                                <td>${taskTypeDisplay(task.type)}</td>
                                <td>${task.schedule_time}</td>
                                <td>
                                    <span class="badge ${task.enabled ? 'badge-success' : 'badge-danger'}">
                                        ${task.enabled ? '启用' : '禁用'}
                                    </span>
                                </td>
                                <td>${formatDate(task.create_time)}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-primary btn-sm" onclick="editTask('${task.id}')">编辑</button>
                                        <button class="btn ${task.enabled ? 'btn-warning' : 'btn-success'} btn-sm" onclick="toggleTask('${task.id}', ${!task.enabled})">
                                            ${task.enabled ? '禁用' : '启用'}
                                        </button>
                                        <button class="btn btn-danger btn-sm" onclick="deleteTask('${task.id}')">删除</button>
                                    </div>
                                </td>
                            `;
                            taskTableBody.appendChild(row);
                        });
                    } else {
                        // 显示无数据提示
                        noTasksDiv.classList.remove('d-none');
                        document.getElementById('taskTableContainer').classList.add('d-none');
                    }
                })
                .catch(error => {
                    showLoading(false);
                    showNotification('加载任务失败', 'error');
                    console.error('Error loading tasks:', error);
                });
        }

        // 创建任务
        function createTask(taskData) {
            showLoading(true);

            fetch('/api/tasks/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(taskData)
            })
            .then(response => response.json())
            .then(data => {
                showLoading(false);

                if (data.success) {
                    showNotification('任务创建成功', 'success');
                    resetForm();
                    loadTasks();
                } else {
                    showNotification(`创建失败: ${data.message || '未知错误'}`, 'error');
                }
            })
            .catch(error => {
                showLoading(false);
                showNotification('创建任务失败', 'error');
                console.error('Error creating task:', error);
            });
        }

        // 获取任务详情
        function getTask(taskId) {
            return fetch(`/api/tasks/get/${taskId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        return data.data;
                    }
                    throw new Error(data.message || '获取任务失败');
                });
        }

        // 编辑任务
        function editTask(taskId) {
            showLoading(true);

            getTask(taskId)
                .then(task => {
                    showLoading(false);

                    // 填充表单 - 使用正确的字段名称
                    document.getElementById('taskId').value = task.id;
                    document.getElementById('taskName').value = task.name || task.task_name;
                    document.getElementById('taskType').value = task.type || task.task_type;
                    document.getElementById('description').value = task.description;
                    document.getElementById('scheduleTime').value = task.schedule_time || task.cron_expression;

                    // 触发任务类型变化事件，更新相关字段显示
                    document.getElementById('taskType').dispatchEvent(new Event('change'));

                    // 填充target_stocks数据
                    if (task.target_stocks && task.target_stocks.length > 0) {
                        const stockInfo = task.target_stocks[0];
                        document.getElementById('dataSource').value = stockInfo.data_source || '';
                        document.getElementById('market').value = stockInfo.market || '';
                        document.getElementById('stockCode').value = stockInfo.stock_code || '';
                        document.getElementById('adjustType').value = stockInfo.adjust_type || 'qfq';
                    }

                    // 填充backtest_config数据
                    if (task.backtest_config) {
                        document.getElementById('strategy').value = task.backtest_config.strategy || '';
                        document.getElementById('initCash').value = task.backtest_config.init_cash || 5000000;
                        document.getElementById('during').value = task.backtest_config.during || 1460;
                    } else if (task.strategy) {
                        // 兼容旧格式
                        document.getElementById('strategy').value = task.strategy;
                    }

                    // 更新表单标题和按钮文本
                    document.getElementById('form-title').textContent = '编辑定时任务';
                    document.getElementById('submitButton').textContent = '更新任务';

                    // 滚动到表单位置
                    document.getElementById('task-form').scrollIntoView({ behavior: 'smooth' });
                })
                .catch(error => {
                    showLoading(false);
                    showNotification('加载任务详情失败', 'error');
                    console.error('Error editing task:', error);
                });
        }

        // 更新任务
        function updateTask(taskId, taskData) {
            showLoading(true);

            fetch(`/api/tasks/update/${taskId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    taskData
                })
            })
            .then(response => response.json())
            .then(data => {
                showLoading(false);

                if (data.success) {
                    showNotification('任务更新成功', 'success');
                    resetForm();
                    loadTasks();
                } else {
                    showNotification(`更新失败: ${data.message || '未知错误'}`, 'error');
                }
            })
            .catch(error => {
                showLoading(false);
                showNotification('更新任务失败', 'error');
                console.error('Error updating task:', error);
            });
        }

        function showConfirmDialog(title, message, onConfirm, onCancel = null) {
            const dialog = document.getElementById('confirmDialog');
            const dialogContent = document.getElementById('confirmDialogContent');
            const dialogTitle = document.getElementById('confirmDialogTitle');
            const dialogMessage = document.getElementById('confirmDialogMessage');
            const confirmBtn = document.getElementById('confirmDialogConfirm');
            const cancelBtn = document.getElementById('confirmDialogCancel');

            // 设置对话框内容
            dialogTitle.textContent = title;
            dialogMessage.textContent = message;

            // 显示对话框
            dialog.classList.remove('hidden');
            // 触发重绘以便应用过渡效果
            void dialog.offsetWidth;
            dialog.classList.add('show');

            // 确认按钮点击处理
            const confirmHandler = () => {
                dialog.classList.remove('show');
                setTimeout(() => {
                    dialog.classList.add('hidden');
                }, 300);
                if (typeof onConfirm === 'function') {
                    onConfirm();
                }
                removeListeners();
            };

            // 取消按钮点击处理
            const cancelHandler = () => {
                dialog.classList.remove('show');
                setTimeout(() => {
                    dialog.classList.add('hidden');
                }, 300);
                if (typeof onCancel === 'function') {
                    onCancel();
                }
                removeListeners();
            };

            // 点击对话框外部关闭
            const backdropHandler = (e) => {
                if (e.target === dialog) {
                    cancelHandler();
                }
            };

            // ESC键关闭对话框
            const keyHandler = (e) => {
                if (e.key === 'Escape') {
                    cancelHandler();
                }
            };

            // 移除事件监听器的函数
            const removeListeners = () => {
                confirmBtn.removeEventListener('click', confirmHandler);
                cancelBtn.removeEventListener('click', cancelHandler);
                dialog.removeEventListener('click', backdropHandler);
                document.removeEventListener('keydown', keyHandler);
            };

            // 添加事件监听器
            confirmBtn.addEventListener('click', confirmHandler);
            cancelBtn.addEventListener('click', cancelHandler);
            dialog.addEventListener('click', backdropHandler);
            document.addEventListener('keydown', keyHandler);
        }


        // 删除任务
        function deleteTask(taskId) {
            showConfirmDialog(
                '确认删除',
                '确定要删除这个任务吗？此操作不可撤销。',
                () => {
                    // 用户确认删除后的处理
                    showLoading(true);

                    fetch(`/api/tasks/delete/${taskId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ id: taskId })
                    })
                    .then(response => response.json())
                    .then(data => {
                        showLoading(false);

                        if (data.success) {
                            showNotification('任务删除成功', 'success');
                            loadTasks();
                        } else {
                            showNotification(`删除失败: ${data.message || '未知错误'}`, 'error');
                        }
                    })
                    .catch(error => {
                        showLoading(false);
                        showNotification('删除任务失败', 'error');
                        console.error('Error deleting task:', error);
                    });
                }
            );
        }
        // 启用/禁用任务
        function toggleTask(taskId, enable) {
            showLoading(true);

            const endpoint = enable ? `/api/tasks/enable/${taskId}` : `/api/tasks/disable/${taskId}`;

            fetch(endpoint, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                showLoading(false);

                if (data.success) {
                    showNotification(`任务${enable ? '启用' : '禁用'}成功`, 'success');
                    loadTasks();
                } else {
                    showNotification(`${enable ? '启用' : '禁用'}失败: ${data.message || '未知错误'}`, 'error');
                }
            })
            .catch(error => {
                showLoading(false);
                showNotification(`${enable ? '启用' : '禁用'}任务失败`, 'error');
                console.error(`Error ${enable ? 'enabling' : 'disabling'} task:`, error);
            });
        }

        // 重置表单
        function resetForm() {
            const form = document.getElementById('taskForm');
            form.reset();
            form.classList.remove('was-validated');
            document.getElementById('taskId').value = '';
            document.getElementById('form-title').textContent = '创建定时任务';
            document.getElementById('submitButton').textContent = '创建任务';
        }

        // 显示加载状态
        function showLoading(show) {
            const loadingDiv = document.getElementById('loading');
            const taskTableContainer = document.getElementById('taskTableContainer');
            const noTasksDiv = document.getElementById('noTasks');

            if (show) {
                loadingDiv.classList.remove('d-none');
                taskTableContainer.classList.add('d-none');
                noTasksDiv.classList.add('d-none');
            } else {
                loadingDiv.classList.add('d-none');
            }
        }

        // 显示通知
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationMessage = document.getElementById('notificationMessage');
            // 重置通知状态并确保正确的定位样式
            notification.style.display = 'none';
            notification.style.position = 'fixed';
            notification.style.top = '1px';  // 距离顶部20px
            notification.style.right = '1px';  // 距离右侧20px
            notification.style.zIndex = '1050';  // 确保在最上层
            // 设置消息内容和类型
            notificationMessage.textContent = message;
            notification.className = `notification position-fixed top-5 right-5 p-3 rounded shadow-lg z-50 ${type}`;

            // 显示通知
            notification.style.display = 'block';


            // 3秒后隐藏通知
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // 格式化任务类型显示
        function taskTypeDisplay(type) {
            const typeMap = {
                'backtest': '股票数据获取+回测+信号检查'
            };
            return typeMap[type] || type;
        }

        // 格式化日期
        function formatDate(timestamp) {
            if (!timestamp) return '';

            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
    </script>
</body>
</html>