<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>定时任务管理 - 股票量化回测系统</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container-fluid p-0">
        <!-- 顶部导航栏 -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
            <div class="container-fluid px-0">
                <div class="content">
                    <div class="d-flex justify-content-between align-items-center w-100">
                        <a class="navbar-brand" href="/">股票量化回测系统</a>
                        <div class="d-flex align-items-center">
                            <div class="navbar-nav me-4">
                                <a class="nav-link" href="/#data-acquisition">数据获取</a>
                                <a class="nav-link active" href="/#backtest">回测</a>
                                <a class="nav-link" href="/#results">历史结果</a>
                                <a class="nav-link" href="/signal_analysis">信号分析</a>
                                <a class="nav-link" href="/strategy_code">策略管理</a>
                                <a class="nav-link" href="/schedule">定时任务</a>
                            </div>
                            <a href="https://github.com/zhaoxusun/stock-quant" target="_blank" class="btn btn-outline-light btn-sm github-link">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-github" viewBox="0 0 16 16">
                                    <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
                                </svg>
                                GitHub
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- 主要内容区域 -->
        <div class="content pt-4">
            <!-- 任务操作卡片 -->
            <div class="card mt-4" id="task-form">
                <div class="card-header bg-primary text-white">
                    <span id="form-title">创建定时任务</span>
                </div>
                <div class="card-body">
                    <form id="taskForm">
                        <input type="hidden" id="taskId" name="taskId">

                        <div class="row g-3">
                            <!-- 任务名称 -->
                            <div class="col-md-4">
                                <label for="taskName" class="form-label">任务名称 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="taskName" name="taskName" placeholder="请输入任务名称" required>
                                <div class="invalid-feedback">任务名称不能为空</div>
                            </div>

                            <!-- 任务类型 -->
                            <div class="col-md-4">
                                <label for="taskType" class="form-label">任务类型 <span class="text-danger">*</span></label>
                                <select class="form-select" id="taskType" name="taskType" required>
                                    <option value="">请选择任务类型</option>
                                    <option value="backtest">股票数据获取+回测+信号检查</option>
                                </select>
                                <div class="invalid-feedback">请选择任务类型</div>
                            </div>

                            <!-- 描述 -->
                            <div class="col-md-4">
                                <label for="description" class="form-label">描述 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="description" name="description" placeholder="请输入任务描述" required>
                                <div class="invalid-feedback">任务描述不能为空</div>
                            </div>

                            <!-- 定时表达式 - 修改宽度为col-md-4 -->
                            <div class="col-md-4">
                                <label for="scheduleTime" class="form-label">定时表达式 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="scheduleTime" name="scheduleTime" placeholder="例如: 0 8 * * 1-5 (工作日早上8点执行)" required>
                                <div class="invalid-feedback">定时表达式不能为空</div>
                                <small class="form-text text-muted mt-1">Cron格式: 分 时 日 月 周</small>
                            </div>


                            <!-- 股票实体列表管理 -->
                            <div class="col-12" id="stockEntitiesContainer">
                                <div class="card">
                                    <div class="card-header">
                                        <span class="mb-0">目标股票列表 <span class="text-danger">*</span></span>
                                    </div>
                                    <div class="card-body">
                                        <!-- 添加股票实体的表单 -->
                                        <div class="row g-3 mb-3 p-3 bg-dark bg-opacity-70 rounded">
                                            <div class="col-md-3">
                                                <label for="newDataSource" class="form-label">数据源</label>
                                                <select class="form-select bg-dark text-light border-secondary" id="newDataSource">
                                                    <option value="akshare">akshare</option>
                                                    <option value="baostock">baostock</option>
                                                    <option value="futu">futu</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label for="newMarket" class="form-label">市场</label>
                                                <select class="form-select bg-dark text-white border-secondary" id="newMarket">
                                                    <option value="us">美股</option>
                                                    <option value="cn">A股</option>
                                                    <option value="hk">港股</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label for="newStockCode" class="form-label">股票代码</label>
                                                <input type="text" class="form-control bg-dark text-white border-secondary placeholder-white" id="newStockCode" placeholder="例如: US.IVV, SH.600519, HK.00700">
                                            </div>
                                            <div class="col-md-3">
                                                <label for="newAdjustType" class="form-label">复权类型</label>
                                                <select class="form-select bg-dark text-white border-secondary" id="newAdjustType">
                                                    <option value="qfq">前复权</option>
                                                    <option value="hfq">后复权</option>
                                                    <option value="None">不复权</option>
                                                </select>
                                            </div>
                                            <div class="col-md-1 align-self-end">
                                                <button type="button" class="btn btn-primary w-100" id="addStockButton">添加股票</button>
                                            </div>
                                        </div>

                                        <!-- 股票实体列表 -->
                                        <div class="overflow-auto" style="max-height: 300px;">
                                            <table class="table table-sm table-dark table-hover" id="stockEntitiesTable">
                                                <thead>
                                                    <tr>
                                                        <th>数据源</th>
                                                        <th>市场</th>
                                                        <th>股票代码</th>
                                                        <th>复权类型</th>
                                                        <th>操作</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="stockEntitiesTableBody">
                                                    <!-- 股票实体将通过JavaScript动态添加 -->
                                                </tbody>
                                            </table>
                                        </div>
                                        <div id="noStockEntities" class="text-center py-4 text-white">
                                            暂无股票实体，请添加至少一个
                                        </div>
                                    </div>
                                </div>
                            </div>


                            <!-- 策略名称 -->
                            <div class="col-md-4" id="strategyField">
                                <label for="strategy" class="form-label">策略选择</label>
                                <select class="form-select" id="strategy" name="strategy" required>
                                    {% for strategy_name in strategies %}
                                    <option value="{{ strategy_name }}">{{ strategy_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- 初始资金 -->
                            <div class="col-md-4" id="initCashField">
                                <label for="initCash" class="form-label">初始资金 <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="initCash" name="initCash" value="5000000" required>
                                <div class="invalid-feedback">初始资金不能为空</div>
                            </div>

                            <!-- 回测周期 -->
                            <div class="col-md-4" id="duringField">
                                <label for="during" class="form-label">回测周期(天) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="during" name="during" value="1460" max="1460" required>
                                <div class="invalid-feedback">回测周期不能为空</div>
                            </div>

                            <!-- 表单按钮 -->
                            <div class="col-12 mt-3">
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary" id="submitButton">创建任务</button>
                                    <button type="button" class="btn btn-secondary" id="cancelButton">取消</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 任务列表卡片 -->
            <div class="card mt-4" id="task-list">
                <div class="card-header bg-primary text-white">
                    <span>定时任务列表</span>
                </div>
                <div class="card-body">
                    <!-- 加载状态 -->
                    <div id="loading" class="d-none text-center py-4">
                        <div class="loading"></div>
                        <p class="mt-2">加载中...</p>
                    </div>

                    <!-- 任务列表 -->
                    <div id="taskTableContainer">
                        <table class="table table-dark table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>任务名称</th>
                                    <th>任务类型</th>
                                    <th>定时表达式</th>
                                    <th>状态</th>
                                    <th>创建时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="taskTableBody">
                                <!-- 任务数据将通过JavaScript动态加载 -->
                            </tbody>
                        </table>
                    </div>

                    <!-- 无数据提示 -->
                    <div id="noTasks" class="d-none text-center py-8">
                        <p>暂无定时任务</p>
                    </div>
                </div>
                <!-- 分页控件 -->
            <div class="card-footer" id="paginationContainer">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="text-white">
                        共 <span id="totalItems"></span> 条记录，每页显示
                        <select id="pageSize" class="form-select form-select-sm d-inline-block w-auto">
                            <option value="2">2</option>
                            <option value="20" selected>20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                        条
                    </div>
                    <nav>
                        <ul class="pagination pagination-sm" id="pagination"></ul>
                    </nav>
                </div>
            </div>
            </div>
        </div>
    </div>

    <!-- 通知组件 -->
    <div id="notification" class="notification position-fixed top-20 right-5 p-4 rounded shadow-lg z-50 transform transition-all duration-300 translate-x-full opacity-0">
        <div id="notificationMessage"></div>
    </div>
    <div id="confirmDialog" class="confirm-dialog hidden">
        <div class="confirm-dialog-content">
            <h3 id="confirmDialogTitle" class="confirm-dialog-title"></h3>
            <p id="confirmDialogMessage" class="confirm-dialog-message"></p>
            <div class="confirm-dialog-buttons">
                <button id="confirmDialogCancel" class="btn btn-secondary">取消</button>
                <button id="confirmDialogConfirm" class="btn btn-danger">确认</button>
            </div>
        </div>
    </div>

    <style>
        /* 确认对话框样式 */
        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1050;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .confirm-dialog.show {
            opacity: 1;
        }

        .confirm-dialog.hidden {
            display: none;
        }

        .confirm-dialog-content {
            background-color: white;
            border-radius: 8px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }

        .confirm-dialog.show .confirm-dialog-content {
            transform: translateY(0);
        }

        .confirm-dialog-title {
            margin-top: 0;
            margin-bottom: 16px;
            font-size: 1.25rem;
            color: #333;
        }

        .confirm-dialog-message {
            margin-bottom: 24px;
            color: #555;
            line-height: 1.5;
        }

        .confirm-dialog-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* 设置placeholder文本为白色 */
        .placeholder-white::placeholder {
            color: white;
            opacity: 0.8; /* 稍微降低透明度以区分实际输入的文本 */
        }

        /* 针对不同浏览器的兼容性 */
        .placeholder-white::-webkit-input-placeholder {
            color: white;
            opacity: 0.8;
        }

        .placeholder-white:-moz-placeholder {
            color: white;
            opacity: 0.8;
        }

        .placeholder-white::-moz-placeholder {
            color: white;
            opacity: 0.8;
        }

        .placeholder-white:-ms-input-placeholder {
            color: white;
            opacity: 0.8;
        }
        /* 分页控件样式 */
        .pagination .page-link {
            background-color: #343a40;
            border-color: #495057;
            color: white;
        }

        .pagination .page-link:hover {
            background-color: #495057;
            border-color: #6c757d;
        }

        .pagination .active .page-link {
            background-color: #007bff;
            border-color: #007bff;
        }

        .pagination .disabled .page-link {
            background-color: #343a40;
            border-color: #495057;
            color: #6c757d;
        }
    </style>

    <script>
        let stockEntities = [];
        // 分页相关变量
        let currentPage = 1;
        let pageSize = 20;
        let totalTasks = [];
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化分页功能
            initPagination();
            // 加载任务列表
            loadTasks();

            // 任务类型选择变化时，动态显示/隐藏相关字段
            document.getElementById('taskType').addEventListener('change', function() {
                const taskType = this.value;
                const stockEntitiesContainer = document.getElementById('stockEntitiesContainer');
                const strategyField = document.getElementById('strategyField');
                const initCashField = document.getElementById('initCashField');
                const duringField = document.getElementById('duringField');

                // 重置必填状态
                document.getElementById('strategy').required = true;
                document.getElementById('initCash').required = true;
                document.getElementById('during').required = true;

                // 根据任务类型显示不同的字段
                if (taskType === 'backtest') {
                    stockEntitiesContainer.classList.remove('d-none');
                    strategyField.classList.remove('d-none');
                    initCashField.classList.remove('d-none');
                    duringField.classList.remove('d-none');
                    document.getElementById('strategy').required = true;
                    document.getElementById('initCash').required = true;
                    document.getElementById('during').required = true;
                }
            });

            // 数据源和市场联动逻辑
            document.getElementById('newDataSource').addEventListener('change', function() {
                const dataSource = this.value;
                const marketSelect = document.getElementById('newMarket');

                // 清空现有选项
                marketSelect.innerHTML = '';

                // 根据数据源添加对应的市场选项
                if (dataSource === 'akshare') {
                    // akshare支持港美市场
                    marketSelect.appendChild(new Option('美股', 'us'));
                    marketSelect.appendChild(new Option('港股', 'hk'));
                } else if (dataSource === 'baostock') {
                    // baostock只支持A股
                    marketSelect.appendChild(new Option('A股', 'cn'));
                } else if (dataSource === 'futu') {
                    // futu支持港A市场
                    marketSelect.appendChild(new Option('A股', 'cn'));
                    marketSelect.appendChild(new Option('港股', 'hk'));
                }
            });

            document.getElementById('newDataSource').dispatchEvent(new Event('change'));

            document.getElementById('addStockButton').addEventListener('click', addStockEntity);

            // 表单提交处理
            document.getElementById('taskForm').addEventListener('submit', function(e) {
                e.preventDefault();

                // 表单验证
                if (!this.checkValidity()) {
                    e.stopPropagation();
                    this.classList.add('was-validated');
                    return;
                }

                // 验证定时表达式
                const scheduleTime = document.getElementById('scheduleTime').value;
                const cronValidation = validateCronExpression(scheduleTime);
                if (!cronValidation.isValid) {
                    showNotification(cronValidation.message, 'error');
                    return;
                }

                if (stockEntities.length === 0) {
                    showNotification('请至少添加一个股票实体', 'error');
                    return;
                }

                const taskId = document.getElementById('taskId').value;
                const taskData = {
                    // 使用正确的字段名称
                    name: document.getElementById('taskName').value,
                    type: document.getElementById('taskType').value,
                    description: document.getElementById('description').value,
                    schedule_time: document.getElementById('scheduleTime').value,
                    enabled: false
                };
                taskData.target_stocks = stockEntities;


                // 添加backtest_config对象
                if (document.getElementById('strategy').required) {
                    taskData.backtest_config = {
                        strategy: document.getElementById('strategy').value
                    };

                    // 添加回测配置的可选字段
                    if (document.getElementById('initCash').required) {
                        taskData.backtest_config.init_cash = parseInt(document.getElementById('initCash').value);
                    }
                    if (document.getElementById('during').required) {
                        taskData.backtest_config.during = parseInt(document.getElementById('during').value);
                    }
                }

                if (taskId) {
                    // 更新任务
                    updateTask(taskId, taskData);
                } else {
                    // 创建任务
                    createTask(taskData);
                }
            });

            // 取消按钮事件
            document.getElementById('cancelButton').addEventListener('click', resetForm);
            document.getElementById('cancelButton').addEventListener('click', loadTasks);

        });

        // 验证Cron表达式格式
        function validateCronExpression(cronExpression) {
            // Cron格式: 分 时 日 月 周
            const parts = cronExpression.trim().split(/\s+/);

            // 检查是否有5个部分
            if (parts.length !== 5) {
                return { isValid: false, message: '定时表达式格式错误，应为：分 时 日 月 周' };
            }

            // 验证分钟 (0-59)
            const minuteRegex = /^(\*|\d{1,2}|\d{1,2}-\d{1,2}|\d{1,2}\/\d{1,2})$|^\d{1,2}(,\d{1,2})*$/;
            if (!minuteRegex.test(parts[0])) {
                return { isValid: false, message: '分钟格式错误，应为0-59之间的数字或通配符' };
            }

            // 验证小时 (0-23)
            const hourRegex = /^(\*|\d{1,2}|\d{1,2}-\d{1,2}|\d{1,2}\/\d{1,2})$|^\d{1,2}(,\d{1,2})*$/;
            if (!hourRegex.test(parts[1])) {
                return { isValid: false, message: '小时格式错误，应为0-23之间的数字或通配符' };
            }

            // 验证日期 (1-31)
            const dayRegex = /^(\*|\d{1,2}|\d{1,2}-\d{1,2}|\d{1,2}\/\d{1,2}|L|W|LW)$|^\d{1,2}(,\d{1,2})*$/;
            if (!dayRegex.test(parts[2])) {
                return { isValid: false, message: '日期格式错误，应为1-31之间的数字或通配符' };
            }

            // 验证月份 (1-12)
            const monthRegex = /^(\*|\d{1,2}|\d{1,2}-\d{1,2}|\d{1,2}\/\d{1,2})$|^\d{1,2}(,\d{1,2})*$/;
            if (!monthRegex.test(parts[3])) {
                return { isValid: false, message: '月份格式错误，应为1-12之间的数字或通配符' };
            }

            // 验证星期 (0-6 或 1-7)
            const weekRegex = /^(\*|[0-7]|[0-7]-[0-7]|[0-7]\/[1-7]|MON|TUE|WED|THU|FRI|SAT|SUN)$|^([0-7](,[0-7])*)$/i;
            if (!weekRegex.test(parts[4])) {
                return { isValid: false, message: '星期格式错误，应为0-7之间的数字或英文缩写(MON-SUN)或通配符' };
            }

            return { isValid: true };
        }

        // 添加股票实体
        function addStockEntity() {
            const dataSource = document.getElementById('newDataSource').value;
            const market = document.getElementById('newMarket').value;
            const stockCode = document.getElementById('newStockCode').value;
            const adjustType = document.getElementById('newAdjustType').value;

            // 验证股票代码
            if (!stockCode.trim()) {
                showNotification('股票代码不能为空', 'error');
                return;
            }

            // 根据市场类型验证股票代码前缀
            let isValidPrefix = true;
            let expectedPrefix = '';

            if (market === 'us') {
                // 美股必须以US.开头
                isValidPrefix = stockCode.startsWith('US.');
                expectedPrefix = 'US.';
            } else if (market === 'hk') {
                // 港股必须以HK.开头
                isValidPrefix = stockCode.startsWith('HK.');
                expectedPrefix = 'HK.';
            } else if (market === 'cn') {
                // A股必须以SH.或SZ.开头
                isValidPrefix = stockCode.startsWith('SH.') || stockCode.startsWith('SZ.');
                expectedPrefix = 'SH.或SZ.';
            }
            if (!isValidPrefix) {
                showNotification(`股票代码格式错误，${market === 'us' ? '美股' : market === 'hk' ? '港股' : 'A股'}股票代码必须以${expectedPrefix}开头`, 'error');
                return;
            }


            // 检查是否已存在相同的股票实体
            const exists = stockEntities.some(entity =>
                entity.data_source === dataSource &&
                entity.market === market &&
                entity.stock_code === stockCode
            );

            if (exists) {
                showNotification('该股票实体已存在', 'error');
                return;
            }

            // 添加到列表
            const newEntity = {
                market: market,
                data_source: dataSource,
                stock_code: stockCode,
                adjust_type: adjustType
            };

            stockEntities.push(newEntity);

            // 更新UI
            renderStockEntities();

            // 清空输入框
            document.getElementById('newStockCode').value = '';

            showNotification('股票实体添加成功', 'success');
        }

        function removeStockEntity(index) {
            stockEntities.splice(index, 1);
            renderStockEntities();
            showNotification('股票实体删除成功', 'success');
        }

        function renderStockEntities() {
            const tableBody = document.getElementById('stockEntitiesTableBody');
            const noStockEntitiesDiv = document.getElementById('noStockEntities');

            tableBody.innerHTML = '';

            if (stockEntities.length > 0) {
                noStockEntitiesDiv.classList.add('d-none');

                stockEntities.forEach((entity, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${entity.data_source}</td>
                        <td>${getMarketDisplay(entity.market)}</td>
                        <td>${entity.stock_code}</td>
                        <td>${getAdjustTypeDisplay(entity.adjust_type)}</td>
                        <td>
                            <button type="button" class="btn btn-danger btn-sm" onclick="removeStockEntity(${index})")>删除</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            } else {
                noStockEntitiesDiv.classList.remove('d-none');
            }
        }

        // 获取市场显示名称
        function getMarketDisplay(market) {
            const marketMap = {
                'us': '美股',
                'cn': 'A股',
                'hk': '港股'
            };
            return marketMap[market] || market;
        }

        // 获取复权类型显示名称
        function getAdjustTypeDisplay(adjustType) {
            const adjustTypeMap = {
                'qfq': '前复权',
                'hfq': '后复权',
                'None': '不复权'
            };
            return adjustTypeMap[adjustType] || adjustType;
        }

        // 加载所有任务
        function loadTasks() {
            showLoading(true);

            fetch('/api/tasks/get_all')
                .then(response => response.json())
                .then(data => {
                    showLoading(false);

                    const taskTableBody = document.getElementById('taskTableBody');
                    const noTasksDiv = document.getElementById('noTasks');
                    const paginationContainer = document.getElementById('paginationContainer');
                    const totalItems = document.getElementById('totalItems');


                    taskTableBody.innerHTML = '';

                    if (data.success && data.data && data.data.length > 0) {
                        // 按create_time倒序排列任务
                        const sortedTasks = data.data.sort((a, b) => {
                            const dateA = new Date(a.create_time || 0).getTime();
                            const dateB = new Date(b.create_time || 0).getTime();
                            return dateB - dateA; // 倒序排列
                        });
                        totalTasks = sortedTasks;

                        // 更新总记录数
                        totalItems.textContent = totalTasks.length;
                        // 显示任务列表和分页
                        noTasksDiv.classList.add('d-none');
                        document.getElementById('taskTableContainer').classList.remove('d-none');
                        paginationContainer.classList.remove('d-none');
                        currentPage = 1;

                        // 渲染当前页的数据
                        renderCurrentPage();
                        // 生成分页按钮
                        renderPagination();
                    } else {
                        totalTasks = [];

                        // 显示无数据提示，隐藏分页
                        noTasksDiv.classList.remove('d-none');
                        document.getElementById('taskTableContainer').classList.add('d-none');
                        paginationContainer.classList.add('d-none');
                        totalItems.textContent = '0';

                    }
                })
                .catch(error => {
                    showLoading(false);
                    showNotification('加载任务失败', 'error');
                    console.error('Error loading tasks:', error);
                });
        }

        // 渲染当前页的数据
        function renderCurrentPage() {
            const taskTableBody = document.getElementById('taskTableBody');
            taskTableBody.innerHTML = '';

            // 计算当前页的数据范围
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, totalTasks.length);
            const currentPageTasks = totalTasks.slice(startIndex, endIndex);

            // 渲染当前页的数据
            currentPageTasks.forEach(task => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${task.id}</td>
                    <td>${task.name}</td>
                    <td>${taskTypeDisplay(task.type)}</td>
                    <td>${task.schedule_time}</td>
                    <td>
                        <span class="badge ${task.enabled ? 'badge-success' : 'badge-danger'}">
                            ${task.enabled ? '启用' : '禁用'}
                        </span>
                    </td>
                    <td>${formatDate(task.create_time)}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-primary btn-sm" onclick="editTask('${task.id}')">编辑</button>
                            <button class="btn ${task.enabled ? 'btn-warning' : 'btn-success'} btn-sm" onclick="toggleTask('${task.id}', ${!task.enabled})")>
                                ${task.enabled ? '禁用' : '启用'}
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteTask('${task.id}')">删除</button>
                        </div>
                    </td>
                `;
                taskTableBody.appendChild(row);
            });
        }

        // 渲染分页按钮
        function renderPagination() {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            // 计算总页数
            const totalPages = Math.ceil(totalTasks.length / pageSize);

            // 首页按钮
            const firstPageItem = document.createElement('li');
            firstPageItem.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            firstPageItem.innerHTML = `<a class="page-link" href="javascript:void(0)" onclick="goToPage(1)">首页</a>`;
            pagination.appendChild(firstPageItem);

            // 上一页按钮
            const prevPageItem = document.createElement('li');
            prevPageItem.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevPageItem.innerHTML = `<a class="page-link" href="javascript:void(0)" onclick="goToPage(${currentPage - 1})">&laquo;</a>`;
            pagination.appendChild(prevPageItem);

            // 页码按钮 - 显示当前页附近的页码
            const maxVisiblePages = 5;
            const startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            const endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            // 调整起始页，确保能显示maxVisiblePages个页码
            const adjustedStartPage = Math.max(1, endPage - maxVisiblePages + 1);

            for (let i = adjustedStartPage; i <= endPage; i++) {
                const pageItem = document.createElement('li');
                pageItem.className = `page-item ${currentPage === i ? 'active' : ''}`;
                pageItem.innerHTML = `<a class="page-link" href="javascript:void(0)" onclick="goToPage(${i})">${i}</a>`;
                pagination.appendChild(pageItem);
            }

            // 下一页按钮
            const nextPageItem = document.createElement('li');
            nextPageItem.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextPageItem.innerHTML = `<a class="page-link" href="javascript:void(0)" onclick="goToPage(${currentPage + 1})">&raquo;</a>`;
            pagination.appendChild(nextPageItem);

            // 末页按钮
            const lastPageItem = document.createElement('li');
            lastPageItem.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            lastPageItem.innerHTML = `<a class="page-link" href="javascript:void(0)" onclick="goToPage(${totalPages})")>末页</a>`;
            pagination.appendChild(lastPageItem);
        }

        // 跳转到指定页
        function goToPage(page) {
            // 确保页码在有效范围内
            const totalPages = Math.ceil(totalTasks.length / pageSize);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                renderCurrentPage();
                renderPagination();
            }
        }

        // 初始化分页相关事件
        function initPagination() {
            // 监听每页显示数量变化
            document.getElementById('pageSize').addEventListener('change', function() {
                pageSize = parseInt(this.value);
                currentPage = 1; // 重置到第一页
                renderCurrentPage();
                renderPagination();
            });
        }


        // 创建任务
        function createTask(taskData) {
            showLoading(true);

            fetch('/api/tasks/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(taskData)
            })
            .then(response => response.json())
            .then(data => {
                showLoading(false);

                if (data.success) {
                    showNotification('任务创建成功', 'success');
                    resetForm();
                    loadTasks();
                } else {
                    showNotification(`创建失败: ${data.message || '未知错误'}`, 'error');
                }
            })
            .catch(error => {
                showLoading(false);
                showNotification('创建任务失败', 'error');
                console.error('Error creating task:', error);
            });
        }

        // 获取任务详情
        function getTask(taskId) {
            return fetch(`/api/tasks/get/${taskId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        return data.data;
                    }
                    throw new Error(data.message || '获取任务失败');
                });
        }

        // 编辑任务
        function editTask(taskId) {
            showLoading(true);

            getTask(taskId)
                .then(task => {
                    showLoading(false);

                    // 填充表单 - 使用正确的字段名称
                    document.getElementById('taskId').value = task.id;
                    document.getElementById('taskName').value = task.name || task.task_name;
                    document.getElementById('taskType').value = task.type || task.task_type;
                    document.getElementById('description').value = task.description;
                    document.getElementById('scheduleTime').value = task.schedule_time || task.cron_expression;

                    // 触发任务类型变化事件，更新相关字段显示
                    document.getElementById('taskType').dispatchEvent(new Event('change'));

                    // 填充target_stocks数据
                    if (task.target_stocks && task.target_stocks.length > 0) {
                        stockEntities = [...task.target_stocks];
                    } else {
                        stockEntities = [];
                    }
                    renderStockEntities();

                    // 填充backtest_config数据
                    if (task.backtest_config) {
                        document.getElementById('strategy').value = task.backtest_config.strategy || '';
                        document.getElementById('initCash').value = task.backtest_config.init_cash || 5000000;
                        document.getElementById('during').value = task.backtest_config.during || 1460;
                    } else if (task.strategy) {
                        // 兼容旧格式
                        document.getElementById('strategy').value = task.strategy;
                    }

                    // 更新表单标题和按钮文本
                    document.getElementById('form-title').textContent = '编辑定时任务';
                    document.getElementById('submitButton').textContent = '更新任务';

                    // 滚动到表单位置
                    document.getElementById('task-form').scrollIntoView({ behavior: 'smooth' });
                })
                .catch(error => {
                    showLoading(false);
                    showNotification('加载任务详情失败', 'error');
                    console.error('Error editing task:', error);
                });
        }

        // 更新任务
        function updateTask(taskId, taskData) {
            showLoading(true);

            fetch(`/api/tasks/update/${taskId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    taskData
                })
            })
            .then(response => response.json())
            .then(data => {
                showLoading(false);

                if (data.success) {
                    showNotification('任务更新成功', 'success');
                    resetForm();
                    loadTasks();
                } else {
                    showNotification(`更新失败: ${data.message || '未知错误'}`, 'error');
                }
            })
            .catch(error => {
                showLoading(false);
                showNotification('更新任务失败', 'error');
                console.error('Error updating task:', error);
            });
        }

        function showConfirmDialog(title, message, onConfirm, onCancel = null) {
            const dialog = document.getElementById('confirmDialog');
            const dialogContent = document.getElementById('confirmDialogContent');
            const dialogTitle = document.getElementById('confirmDialogTitle');
            const dialogMessage = document.getElementById('confirmDialogMessage');
            const confirmBtn = document.getElementById('confirmDialogConfirm');
            const cancelBtn = document.getElementById('confirmDialogCancel');

            // 设置对话框内容
            dialogTitle.textContent = title;
            dialogMessage.textContent = message;

            // 显示对话框
            dialog.classList.remove('hidden');
            // 触发重绘以便应用过渡效果
            void dialog.offsetWidth;
            dialog.classList.add('show');

            // 确认按钮点击处理
            const confirmHandler = () => {
                dialog.classList.remove('show');
                setTimeout(() => {
                    dialog.classList.add('hidden');
                }, 300);
                if (typeof onConfirm === 'function') {
                    onConfirm();
                }
                removeListeners();
            };

            // 取消按钮点击处理
            const cancelHandler = () => {
                dialog.classList.remove('show');
                setTimeout(() => {
                    dialog.classList.add('hidden');
                }, 300);
                if (typeof onCancel === 'function') {
                    onCancel();
                }
                removeListeners();
            };

            // 点击对话框外部关闭
            const backdropHandler = (e) => {
                if (e.target === dialog) {
                    cancelHandler();
                }
            };

            // ESC键关闭对话框
            const keyHandler = (e) => {
                if (e.key === 'Escape') {
                    cancelHandler();
                }
            };

            // 移除事件监听器的函数
            const removeListeners = () => {
                confirmBtn.removeEventListener('click', confirmHandler);
                cancelBtn.removeEventListener('click', cancelHandler);
                dialog.removeEventListener('click', backdropHandler);
                document.removeEventListener('keydown', keyHandler);
            };

            // 添加事件监听器
            confirmBtn.addEventListener('click', confirmHandler);
            cancelBtn.addEventListener('click', cancelHandler);
            dialog.addEventListener('click', backdropHandler);
            document.addEventListener('keydown', keyHandler);
        }


        // 删除任务
        function deleteTask(taskId) {
            showConfirmDialog(
                '确认删除',
                '确定要删除这个任务吗？此操作不可撤销。',
                () => {
                    // 用户确认删除后的处理
                    showLoading(true);

                    fetch(`/api/tasks/delete/${taskId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ id: taskId })
                    })
                    .then(response => response.json())
                    .then(data => {
                        showLoading(false);

                        if (data.success) {
                            showNotification('任务删除成功', 'success');
                            loadTasks();
                        } else {
                            showNotification(`删除失败: ${data.message || '未知错误'}`, 'error');
                        }
                    })
                    .catch(error => {
                        showLoading(false);
                        showNotification('删除任务失败', 'error');
                        console.error('Error deleting task:', error);
                    });
                }
            );
        }
        // 启用/禁用任务
        function toggleTask(taskId, enable) {
            showLoading(true);

            const endpoint = enable ? `/api/tasks/enable/${taskId}` : `/api/tasks/disable/${taskId}`;

            fetch(endpoint, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                showLoading(false);

                if (data.success) {
                    showNotification(`任务${enable ? '启用' : '禁用'}成功`, 'success');
                    loadTasks();
                } else {
                    showNotification(`${enable ? '启用' : '禁用'}失败: ${data.message || '未知错误'}`, 'error');
                }
            })
            .catch(error => {
                showLoading(false);
                showNotification(`${enable ? '启用' : '禁用'}任务失败`, 'error');
                console.error(`Error ${enable ? 'enabling' : 'disabling'} task:`, error);
            });
        }

        // 重置表单
        function resetForm() {
            const form = document.getElementById('taskForm');
            form.reset();
            form.classList.remove('was-validated');
            document.getElementById('taskId').value = '';
            document.getElementById('form-title').textContent = '创建定时任务';
            document.getElementById('submitButton').textContent = '创建任务';
            // 清空股票实体列表
            stockEntities = [];
            renderStockEntities();
        }

        // 显示加载状态
        function showLoading(show) {
            const loadingDiv = document.getElementById('loading');
            const taskTableContainer = document.getElementById('taskTableContainer');
            const noTasksDiv = document.getElementById('noTasks');

            if (show) {
                loadingDiv.classList.remove('d-none');
                taskTableContainer.classList.add('d-none');
                noTasksDiv.classList.add('d-none');
            } else {
                loadingDiv.classList.add('d-none');
            }
        }

        // 显示通知
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationMessage = document.getElementById('notificationMessage');
            // 重置通知状态并确保正确的定位样式
            notification.style.display = 'none';
            notification.style.position = 'fixed';
            notification.style.top = '1px';  // 距离顶部20px
            notification.style.right = '1px';  // 距离右侧20px
            notification.style.zIndex = '1050';  // 确保在最上层
            // 设置消息内容和类型
            notificationMessage.textContent = message;
            notification.className = `notification position-fixed top-5 right-5 p-3 rounded shadow-lg z-50 ${type}`;

            // 显示通知
            notification.style.display = 'block';


            // 3秒后隐藏通知
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // 格式化任务类型显示
        function taskTypeDisplay(type) {
            const typeMap = {
                'backtest': '股票数据获取+回测+信号检查'
            };
            return typeMap[type] || type;
        }

        // 格式化日期
        function formatDate(timestamp) {
            if (!timestamp) return '';

            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
    </script>
</body>
</html>